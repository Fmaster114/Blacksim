<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

const WORLD_WIDTH = 2000;
const WORLD_HEIGHT = 2000;

let cotton = 0;
const keys = {};
const particles = [];
let tick = 0;

// ---------------- Kamera ----------------
const camera = { x: 0, y: 0 };

// ---------------- Farmer ----------------
const farmer = {
  x: 1000,
  y: 1000,
  size: 16,
  speed: 3
};

// ---------------- Pflanzen ----------------
const plants = [];
const GROW_TIME = 5000;

for (let x = 200; x < WORLD_WIDTH; x += 120) {
  for (let y = 200; y < WORLD_HEIGHT; y += 120) {
    plants.push({
      x, y,
      stage: 3,
      lastGrow: Date.now()
    });
  }
}

// ---------------- Input ----------------
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// ---------------- Partikel ----------------
function spawnParticles(x, y) {
  for (let i = 0; i < 8; i++) {
    particles.push({
      x, y,
      vx: (Math.random()-0.5)*2,
      vy: Math.random()*-2,
      life: 30
    });
  }
}

// ---------------- Update ----------------
function update() {
  tick++;

  if (keys["w"] || keys["ArrowUp"]) farmer.y -= farmer.speed;
  if (keys["s"] || keys["ArrowDown"]) farmer.y += farmer.speed;
  if (keys["a"] || keys["ArrowLeft"]) farmer.x -= farmer.speed;
  if (keys["d"] || keys["ArrowRight"]) farmer.x += farmer.speed;

  farmer.x = Math.max(40, Math.min(WORLD_WIDTH-40, farmer.x));
  farmer.y = Math.max(40, Math.min(WORLD_HEIGHT-40, farmer.y));

  camera.x = Math.floor(farmer.x - canvas.width / 2);
  camera.y = Math.floor(farmer.y - canvas.height / 2);

  plants.forEach(p => {
    if (p.stage < 3 && Date.now() - p.lastGrow > GROW_TIME) {
      p.stage++;
      p.lastGrow = Date.now();
    }
  });

  if (keys[" "]) {
    plants.forEach(p => {
      const d = Math.hypot(p.x - farmer.x, p.y - farmer.y);
      if (d < 32 && p.stage === 3) {
        p.stage = 0;
        p.lastGrow = Date.now();
        cotton++;
        spawnParticles(p.x, p.y);
        document.getElementById("cotton").textContent = cotton;
      }
    });
  }

  particles.forEach(pt => {
    pt.x += pt.vx;
    pt.y += pt.vy;
    pt.vy += 0.15;
    pt.life--;
  });

  for (let i = particles.length - 1; i >= 0; i--) {
    if (particles[i].life <= 0) particles.splice(i, 1);
  }
}

// ---------------- Helpers ----------------
function wx(x){ return Math.floor(x - camera.x); }
function wy(y){ return Math.floor(y - camera.y); }

// ---------------- Draw ----------------
function drawGround() {
  ctx.fillStyle = "#3e8e41";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#357a38";
  for (let y = -camera.y % 64; y < canvas.height; y += 64) {
    ctx.fillRect(0, y, canvas.width, 2);
  }
}

function drawPlant(p) {
  const px = wx(p.x);
  const py = wy(p.y);

  // Schatten
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(px - 10, py + 22, 20, 6);

  // Stiel (Pixel)
  ctx.fillStyle = "#2e7d32";
  ctx.fillRect(px - 2, py, 4, 28);

  // Baumwolle (Pixel-Art Bollen)
  const bollLayouts = [
    [], // 0
    [[0,0]],
    [[-6,0],[6,0]],
    [[-6,0],[6,0],[0,-6]]
  ];

  const layout = bollLayouts[p.stage];
  layout.forEach(o => {
    // Schatten Boll
    ctx.fillStyle = "rgba(0,0,0,0.3)";
    ctx.fillRect(px + o[0] - 5, py + o[1] + 3, 10, 6);

    // Boll
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(px + o[0] - 6, py + o[1] - 6, 12, 12);

    // Highlight
    ctx.fillStyle = "#eeeeee";
    ctx.fillRect(px + o[0] - 4, py + o[1] - 4, 5, 5);
  });
}

function drawFarmer() {
  const x = wx(farmer.x);
  const y = wy(farmer.y);

  // Schatten
  ctx.fillStyle = "rgba(0,0,0,0.3)";
  ctx.fillRect(x - 10, y + 28, 20, 6);

  // Kopf
  ctx.fillStyle = "#573E1F";
  ctx.fillRect(x - 8, y - 20, 16, 16);

  // KÃ¶rper
  ctx.fillStyle = "#1976d2";
  ctx.fillRect(x - 10, y, 20, 28);
}

function drawParticles() {
  particles.forEach(p => {
    ctx.fillStyle = "rgba(255,255,255,"+(p.life/30)+")";
    ctx.fillRect(wx(p.x), wy(p.y), 4, 4);
  });
}

function draw() {
  drawGround();
  plants.forEach(drawPlant);
  drawParticles();
  drawFarmer();
}

// ---------------- Loop ----------------
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
